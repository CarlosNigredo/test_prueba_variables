<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Variables tipográficas</title>
    <script src="jspsych/dist/jspsych.js"></script>
    <script src="jspsych/dist/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/dist/plugin-instructions.js"></script>
    <script src="jspsych/dist/plugin-html-button-response.js"></script>
    <link rel="stylesheet" href="jspsych/dist/jspsych.css">
    <link rel="stylesheet" href="css/customStyles.css">
</head>
<body></body>
<script>
    const jsPsych = initJsPsych();
    const timeline = [];

    // VARIABLES
    // var direccionSerieInicial;
    var direccionSerie;
    var estimuloModelo = 110;
    var estimuloComparacion;
    var pesoFuente;
    var nuevoEnsayo;
    var nuevaSerie;

    let signoRespuesta;
    var contadorEnsayos = 0;
    var erroresConsecutivos = 0;
    var ubicacionModelo;
    var ubicacionComparacion;
    var ubicacionesEstimulos = {};
    var respuestaIngresada;
    var cadenaRespuestas = [];

    const iniciosDescendentes = [160, 140, 180, 170, 150];
    const iniciosAscendentes = [80, 70, 60, 50, 40];
    // var valoresIniciales;

    
    // FUNCIONES
    const claseEstimulo = function () {
        var tiposEstimulo = ["modelo", "comparacion"]
        
        const stimuliContainers = document.querySelectorAll(".stimulus");

        for (let i = 0; i < stimuliContainers.length; i++) {
            stimuliContainers[i].classList.add(tiposEstimulo.splice( Math.floor(Math.random()*tiposEstimulo.length), 1 )[0]);
        }
    }

    const pesoEstimulos = function () {
        //var pesoFuente;

        //seleccionar contenedor con clase .modelo y modificar peso de fuente
        const modelo = document.querySelector(".modelo");
        modelo.style.cssText = "font-variation-settings:'wght'" + estimuloModelo;

        //seleccionar contenedor con clase .comparacion y modificar peso de fuente, de acuerdo con la dirección de la serie
        const comparacion = document.querySelector(".comparacion");

        switch(contadorEnsayos){
            case 1:
                console.log('Este es el primer ensayo');
                if (direccionSerie === "ascendente") {
                    pesoFuente = iniciosAscendentes.splice( Math.floor(Math.random()*iniciosAscendentes.length), 1 )[0];
                    comparacion.style.cssText = "font-variation-settings:'wght'" + pesoFuente;
                    console.log(pesoFuente);
                    //console.log(iniciosAscendentes);
                } else if (direccionSerie === "descendente") {
                    pesoFuente = iniciosDescendentes.splice( Math.floor(Math.random()*iniciosDescendentes.length), 1 )[0];
                    comparacion.style.cssText = "font-variation-settings:'wght'" + pesoFuente;
                }
                break;
            default:
                console.log('Ensayo subsecuente');
                if (direccionSerie === "ascendente") {
                    console.log(pesoFuente);
                    pesoFuente+=4;
                    comparacion.style.cssText = "font-variation-settings:'wght'" + pesoFuente;
                    console.log(pesoFuente);
                } else if (direccionSerie === "descendente") {
                    pesoFuente-=4;
                    comparacion.style.cssText = "font-variation-settings:'wght'" + pesoFuente;
                }
        }

        

        
    }

    const obtenerUbicaciones = function() {
        const container = document.querySelectorAll(".stimulus");

        for(let i = 0; i < container.length; i++) {
            var tipoEstimulo = container[i].className.split(' ').pop();
            var ubicacionEstimulo = container[i].className.split(' ')[1];
            ubicacionesEstimulos[tipoEstimulo] = ubicacionEstimulo;
        }
        console.log(ubicacionesEstimulos);
    }

    const evaluarRespuesta = function() {
        // Evaluar la respuesta para decidir si se corre un nuevo ensayo

        switch(jsPsych.data.getLastTrialData().values()[0].response) {
            case 0:
                respuestaIngresada = 'izquierda';
                break;
            case 1:
                respuestaIngresada = 'igual';
                break;
            case 2:
                respuestaIngresada = 'derecha';
        }

        console.log(respuestaIngresada);

    }

    // Traduce respuestaIngresada a signo ('+','-','='); lo añade a cadenaRespuestas
    var respuestas_a_Signos = function() {

        //let signoRespuesta;

        switch(respuestaIngresada){
            case(ubicacionesEstimulos['modelo']):
                signoRespuesta = '-';
                cadenaRespuestas.push(signoRespuesta);
                break;
            
            case('igual'):
                signoRespuesta = '=';
                cadenaRespuestas.push(signoRespuesta);
                break;

            case(ubicacionesEstimulos['comparacion']):
                signoRespuesta = '+';
                cadenaRespuestas.push(signoRespuesta);
        }


        //jsPsych.data.getLastTrialData().addProperties( {responseSign: signoRespuesta} );

        // Este se lo añade a toooooodo
        //jsPsych.data.addProperties( {responseSign: signoRespuesta} );

        //return signoRespuesta;
        // ¿Meter esta respuesta en la estructura de datos???

    }

    // Verifica cambio consecutivo de signo
    var errorConsecutivo = function() {

        //let revisionNecesaria = false;

        if (cadenaRespuestas.length >= 2) {
            //revisionNecesaria = true;
            if (signoRespuesta == cadenaRespuestas.pop()) {
                console.log('YA TE EQUIVOCASTE DOS VECES!!!')
            }
        }

    }

    
    // PANTALLAS    
    var inicioSerie = {
        type: jsPsychInstructions,
        pages: ['<p style="font-size:40px">Nueva serie</p>']
    }
    
    var pantallaReposo = {
        //Acá se haría la asignación de la dirección de la primera serie, porque en las instrucciones el participante toma control de los aparatos de input, y solo comenzaría su prueba dando clic en algún botón o presienando Enter. Cambiaría el TYPE de instrucciones
    }
    
    var instrucciones = {
        //Esta es la presentación y aquí se define la dirección de la serie inicial
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<span style="font-size:40px;">WELCOME</span>',
        choices: ['a', 'd'],
        on_finish: function(data){
            // 1 Seleccionar direccion de la primera serie

            var direccionSeleccionada = event.key;

            if (direccionSeleccionada === "a") {
                direccionSerie = "ascendente";
                // valoresIniciales = iniciosAscendentes;
            } else if (direccionSeleccionada === "d") {
                direccionSerie = "descendente";
                // valoresIniciales = iniciosDescendentes;
            }

            //data.direccionSerie = direccionSerie;

            console.log(direccionSeleccionada);
            console.log(direccionSerie);
            //console.log(direccionSerieInicial);


            // 2 Asignar un valor a estimuloComparacion, según corresponda al inicio Ascendente o Descendente

            // 3 Se asigna ID del participante (Ejemplo: 061320221350)
            // Tomar fecha y hora y dejar solo cadena de números (o tal vez dejarlo así)
            //asignaIdParticipante();
        }
    }
    timeline.push(instrucciones);

    var cruzFijacion = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<span style="font-size:40px;">+</span>',
        choices: 'NO_KEYS',
        trial_duration: 2000
    }

    var estimulos = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<div class="stimulus izquierda inline">M</div><div class="spacerAngle inline" style="width: 2em;"></div><div class="stimulus derecha inline">M</div>',
        options: 'NO_KEYS',
        trial_duration: 250,
        //aqui tenemos que asignar aleatoriamente la clase
        on_load: function(){
            contadorEnsayos++;
            console.log(contadorEnsayos);
            claseEstimulo();
            pesoEstimulos();
            obtenerUbicaciones();
        }
    }

    var pantallaRespuestas = {
        type: jsPsychHtmlButtonResponse,
        stimulus: '<p>¿Cuál tenía mayor peso?</p>',
        choices: ['<','=','>'],
        on_finish: function(data){
            evaluarRespuesta();
            respuestas_a_Signos();
            // errorConsecutivo();
            console.log(cadenaRespuestas);
            data.responseSign = signoRespuesta;
            jsPsych.data.displayData();
            //jsPsych.data.get().localSave('csv', 'data.csv');
        }
    }

    // REPITE ENSAYO HASTA QUE SE DEBA INICIAR OTRA SERIE
    var ensayo = {
        timeline: [cruzFijacion, estimulos, pantallaRespuestas],
        loop_function: function(data) {
            
            switch(direccionSerie){

                case('ascendente'):
                    if ( respuestaIngresada == ubicacionesEstimulos['modelo'] || respuestaIngresada == 'igual') {
                        // respuestas_a_Signos();
                        // console.log(cadenaRespuestas);
                        console.log('Se tiene que correr otro ensayo');
                        nuevoEnsayo = true;
                        nuevaSerie = false;
                        return true;
                    } else if (respuestaIngresada == ubicacionesEstimulos['comparacion']) {
                        erroresConsecutivos++;
                        //respuestas_a_Signos();
                        //ESTO NO CUENTA ERRORES CONSECUTIVOS
                        // array1 = array1.filter(function(val){
                        //     return array2.indexOf(val) == -1;
                        // })
                        console.log('Este es tu error número: '+erroresConsecutivos);
                        switch(erroresConsecutivos){
                            case 0:
                            case 1:
                                nuevoEnsayo = true;
                                nuevaSerie = false; 
                                return true;
                                break;
                            case 2:
                                nuevoEnsayo = false;
                                nuevaSerie = true;
                                return false;
                        }   
                    }
                    break;

                case('descendente'):
                    if ( respuestaIngresada == ubicacionesEstimulos['comparacion'] || respuestaIngresada == 'igual') {
                        //respuestas_a_Signos();
                        console.log('Se tiene que correr otro ensayo');
                        //console.log(cadenaRespuestas);
                        nuevoEnsayo = true;
                        nuevaSerie = false;
                        return true;
                    } else {
                        //respuestas_a_Signos();
                        //console.log(cadenaRespuestas);
                        console.log('Termina esta serie');
                        nuevoEnsayo = false;
                        nuevaSerie = true;
                        return false;
                    }
            }
        }
    }
    //timeline.push(ensayo);

    //REPITE SERIES HASTA QUE TERMINE EL EXPERIMENTO
    var serie = {
        timeline: [inicioSerie, ensayo],
        // timeline_variables: [
        //     {valorInicial: }
        // ]
        loop_function: function(data){
            switch(nuevaSerie){
                case(true):

                    return true;
                    break;
                case(false):
                    return false;
            }
        }
    }
    timeline.push(serie);

    console.log(timeline);

    jsPsych.run(timeline);
</script>
</html>